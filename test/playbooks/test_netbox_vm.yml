- name: Test netbox_vm module
  hosts: localhost
  vars:
    netbox_url: 'https://netbox.int.easydns.net'
    netbox_token: '{{ lookup("file", "/etc/ansible/netbox_private_token").split(" ")[-1] }}'
  tasks:
    - name: 'create a vm in netbox'
      netbox_vm:
        netbox_url: '{{ netbox_url }}'
        netbox_token: '{{ netbox_token }}'
        state: 'present'
        data:
          name: 'scapegoat2'
          cluster: 'kvm05-pco'
      register: create_op
    - name: 'dump output of create'
      debug:
        var: create_op
    - name: 'update the vm'
      netbox_vm:
        netbox_url: '{{ netbox_url }}'
        netbox_token: '{{ netbox_token }}'
        state: 'present'
        data:
          name: 'scapegoat2'
          memory: 8
          vcpus: 4
          disk: 20
      register: update_op
    - name: 'dump output of update'
      debug:
        var: update_op
    - name: 'make sure of idempotence by updating again with the same data'
      netbox_vm:
        netbox_url: '{{ netbox_url }}'
        netbox_token: '{{ netbox_token }}'
        state: 'present'
        data:
          name: 'scapegoat2'
          memory: 8
          vcpus: 4
          disk: 20
      register: update_op
    - name: 'dump output of un-necessary update'
      debug:
        var: update_op
    - name: 'delete vm from netbox'
      netbox_vm:
        netbox_url: '{{ netbox_url }}'
        netbox_token: '{{ netbox_token }}'
        state: 'absent'
        data:
          name: 'scapegoat2'
      register: delete_op
    - name: 'dump output of delete'
      debug:
        var: delete_op
    - name: 'what if we just want to make sure it has gone'
      netbox_vm:
        netbox_url: '{{ netbox_url }}'
        netbox_token: '{{ netbox_token }}'
        state: 'absent'
        data:
          name: 'scapegoat2'
      register: delete_op
    - name: 'dump output of second delete'
      debug:
        var: delete_op
